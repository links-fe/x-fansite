name: Release

on:
  workflow_dispatch:
    inputs:
      env_var:
        description: 'env version'
        required: false
      runId:
        description: 'runId'
        required: true
      id:
        description: 'id'
        required: true

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2
        # æ£€å‡ºä»£ç ä»“åº“ï¼Œåç»­æ­¥éª¤éœ€è¦ä»£ç ä¸Šä¸‹æ–‡

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}
        # é…ç½® AWS CLI æ‰€éœ€å‡­è¯å’ŒåŒºåŸŸ

      - name: Pick Publish Folder
        id: pick_publish_folder
        run: |
          echo "å½“å‰åˆ†æ”¯ï¼š${GITHUB_REF#refs/heads/}"
          BRANCH=${GITHUB_REF#refs/heads/}
          if [ "$BRANCH" = "release/test" ]; then
            echo "åˆ†æ”¯åŒ¹é… release/testï¼Œå‘å¸ƒæ–‡ä»¶å¤¹è®¾ç½®ä¸º test"
            echo "folder=test" >> $GITHUB_OUTPUT
          else
            echo "åˆ†æ”¯ä¸åŒ¹é…ï¼Œå‘å¸ƒæ–‡ä»¶å¤¹è®¾ç½®ä¸º dev"
            echo "folder=dev" >> $GITHUB_OUTPUT
          fi
        # æ ¹æ®åˆ†æ”¯å†³å®šå‘å¸ƒç›®å½•ï¼Œç»“æœé€šè¿‡ GITHUB_OUTPUT ä¼ é€’ç»™åç»­æ­¥éª¤

      - name: Upload to S3
        id: upload
        run: |
          set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

          FOLDER=${{ steps.pick_publish_folder.outputs.folder }}
          RUN_ID=${{ github.event.inputs.runId }}

          echo "å¼€å§‹ä¸Šä¼ æ–‡ä»¶"
          echo "å‘å¸ƒç›®å½•: $FOLDER"
          echo "runId: $RUN_ID"

          echo "åŒæ­¥é™¤ *.html å¤–çš„æ–‡ä»¶..."
          aws s3 sync "s3://${{ vars.DIST_AWS_BUCKET_NAME }}/$RUN_ID" "s3://${{ vars.TARGET_BUCKET_NAME }}/$FOLDER/" --exclude "*.html"

          echo "ä¸Šä¼  *.html æ–‡ä»¶ï¼Œå¹¶è®¾ç½®ç¼“å­˜ç­–ç•¥ä¸º no-store..."
          aws s3 cp "s3://${{ vars.DIST_AWS_BUCKET_NAME }}/$RUN_ID/" "s3://${{ vars.TARGET_BUCKET_NAME }}/$FOLDER/" --recursive --exclude "*" --include "*.html" --cache-control no-store

          echo "ä¸Šä¼ å®Œæˆï¼Œå†™å…¥ä¸Šä¼ ç»“æœçŠ¶æ€"
          echo "upload_result=success" >> $GITHUB_OUTPUT
        continue-on-error: false
        # ä¸Šä¼ æ–‡ä»¶åˆ°ç›®æ ‡æ¡¶ï¼Œå¤±è´¥æ—¶åœæ­¢æµç¨‹

      - name: Upload Result
        run: |
          echo "ä¸Šä¼ çŠ¶æ€ï¼š${{ steps.upload.outputs.upload_result }}"
          if [ "${{ steps.upload.outputs.upload_result }}" = "success" ]; then
            echo "æ–‡ä»¶ä¸Šä¼ æˆåŠŸ ğŸ‰"
          else
            echo "æ–‡ä»¶ä¸Šä¼ å¤±è´¥ âŒ"
            exit 1
          fi
        # æ‰“å°ä¸Šä¼ ç»“æœï¼Œå¤±è´¥åˆ™è®©ä½œä¸šå¤±è´¥
